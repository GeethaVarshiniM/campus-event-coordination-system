package com.example.demo.service;

import com.example.demo.entity.Event;
import com.example.demo.entity.Registration;
import com.example.demo.repository.EventRepository;
import com.example.demo.repository.RegistrationRepository;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class RegistrationService {

    private final RegistrationRepository registrationRepository;
    private final EventRepository eventRepository;
    private final EmailService emailService;

    public RegistrationService(RegistrationRepository registrationRepository,
                               EventRepository eventRepository,
                               EmailService emailService) {
        this.registrationRepository = registrationRepository;
        this.eventRepository = eventRepository;
        this.emailService = emailService;
    }

    // ✅ REGISTER STUDENT FOR EVENT
    public Registration saveRegistration(Long eventId, Registration registration) {

        boolean alreadyRegistered =
                registrationRepository.existsByEmailAndEvent_Id(
                        registration.getEmail(), eventId);

        if (alreadyRegistered) {
            throw new RuntimeException("Already registered for this event");
        }

        Event event = eventRepository.findById(eventId)
                .orElseThrow(() -> new RuntimeException("Event not found"));

        registration.setEvent(event);

        Registration saved = registrationRepository.save(registration);

        // Optional: confirmation email
        emailService.sendEmail(
                saved.getEmail(),
                "✅ Registration Confirmed: " + event.getTitle(),
                "Hello,\n\n"
                        + "You have successfully registered for the event.\n\n"
                        + "Event: " + event.getTitle() + "\n"
                        + "Date: " + event.getDate() + "\n"
                        + "Venue: " + event.getVenue() + "\n\n"
                        + "Regards,\n"
                        + "College Event Management Team"
        );

        return saved;
    }

    // ✅ CHECK REGISTRATION
    public boolean isAlreadyRegistered(String email, Long eventId) {
        return registrationRepository.existsByEmailAndEvent_Id(email, eventId);
    }

    // ✅ GET REGISTRATIONS FOR EVENT (TABLE)
    public List<Registration> getRegistrationsByEvent(Long eventId) {
        return registrationRepository.findByEvent_Id(eventId);
    }

    // ✅ CSV GENERATION
    public String generateCsvForEvent(Long eventId) {

        List<Registration> registrations =
                registrationRepository.findByEvent_Id(eventId);

        StringBuilder csv = new StringBuilder();
        csv.append("Name,Email,Register Number,Department\n");

        for (Registration r : registrations) {
            csv.append(r.getUser().getName()).append(",")
               .append(r.getUser().getEmail()).append(",")
               .append(r.getUser().getRegNumber()).append(",")
               .append(r.getUser().getDepartment()).append("\n");
        }

        return csv.toString();
    }

    // ✅ CHART: REGISTRATIONS COUNT FOR EVENT
    public List<Object[]> getRegistrationsForEvent(Long eventId) {
        return registrationRepository.countRegistrationsForEvent(eventId);
    }

    // ✅ CHART: DEPARTMENT SPLIT FOR EVENT
    public List<Object[]> getDepartmentsForEvent(Long eventId) {
        return registrationRepository.countDepartmentsForEvent(eventId);
    }

    // ✅ SEND REMINDER EMAILS
    public void sendReminderEmails(Long eventId) {

        List<Registration> registrations =
                registrationRepository.findByEvent_Id(eventId);

        for (Registration r : registrations) {
            emailService.sendEmail(
                    r.getUser().getEmail(),
                    "⏰ Event Reminder: " + r.getEvent().getTitle(),
                    "Hello " + r.getUser().getName() + ",\n\n"
                            + "This is a reminder for the upcoming event.\n\n"
                            + "Event: " + r.getEvent().getTitle() + "\n"
                            + "Date: " + r.getEvent().getDate() + "\n"
                            + "Venue: " + r.getEvent().getVenue() + "\n\n"
                            + "Regards,\n"
                            + "College Event Management Team"
            );
        }@Service
        public class RegistrationService {

            private final RegistrationRepository registrationRepository;
            private final EventRepository eventRepository;

            public RegistrationService(RegistrationRepository registrationRepository,
                                       EventRepository eventRepository) {
                this.registrationRepository = registrationRepository;
                this.eventRepository = eventRepository;
            }

            public Registration saveRegistration(Long eventId, User user) {

                boolean alreadyRegistered =
                        registrationRepository.existsByEmailAndEvent_Id(
                                user.getEmail(), eventId);

                if (alreadyRegistered) {
                    throw new RuntimeException("Already registered");
                }

                Event event = eventRepository.findById(eventId)
                        .orElseThrow(() -> new RuntimeException("Event not found"));

                Registration registration = new Registration();
                registration.setEmail(user.getEmail());
                registration.setRegNumber(user.getRegNumber());
                registration.setDepartment(user.getDepartment());
                registration.setPhone(user.getPhone());
                registration.setEvent(event);

                return registrationRepository.save(registration);
            }

            public boolean isAlreadyRegistered(String email, Long eventId) {
                return registrationRepository.existsByEmailAndEvent_Id(email, eventId);
            }
        }

    }
}
